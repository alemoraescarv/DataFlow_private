```python
import logging
import random

import apache_beam as beam
from apache_beam import Create, Map, ParDo, Flatten, Partition
from apache_beam import pvalue
```

# Apache Beam Basics

In this Colab we would go over basic operations within Apache Beam. After going throught them, there will be some use cases examples in which we can test our knowledge

Two concepts we would use during the notebooks:
- **Element**: minimal unit of data.
- **PCollection**: represents a distribute data set, it can be bounded or unbounded. Made of element(s).

Before running into code, let's see the basic structure using the pipeline:

- The pipe `|` separates steps within the pipeline. Every time we want to add a new step, we need a new pipe.
- At the right of the pipe, we add the step we want to execute, ` | <STEP> `. We can optionally name the step using `>>` between the step and the pipe ` | "NAME" >> <STEP>`.
- At the left of the pipe, there has to be a reference to a subpipeline. At the beginning we can use `p=beam.Pipeline()` but later we need to reference a subpipeline. I.e., `p | <STEP>`, `p | <STEP1> | <STEP2>...` or `squares | <STEP>` (where squares is a variable of a subpipeline).

In Java, the structure is `p.apply("NAME", <STEP>).apply("NAME2", <STEP2>)...`


To not overload the notebook with logs, let's specify what we want to log. Change it to INFO if you want to have more perspective of what's happening inside Apache Beam.


```python
logging.getLogger().setLevel(logging.WARNING)
```

During this first notebook, we will use the `InteractiveRunner` in some pipelines, so we can see their graphs. We won't do it in the following notebooks so we don't clutter it, but feel free to import it and add it if you need visual help.


```python
from apache_beam.runners.interactive.interactive_runner import InteractiveRunner
```

<br>

**We are going to start off with some basic operations and at the end we will have an exercise for you.**

## Basic Operations

**Create** is used to create elements.

**Map** does a operation element level. Takes an element and applies a operation to it. It's a 1 to 1 operation.

During most of the following examples we are going to use `Create` as source in this examples, since it's more intuitive than using CSVs or other sources. `Map` will be used to print the elements so we can check the outputs.

The following pipeline returns the squares of the N first non negatives integers


```python
with beam.Pipeline(InteractiveRunner()) as p:
    N = 13

    squares = (p | "Create Elements" >> Create(range(N))
               | "Squares" >> Map(lambda x: x**2)
               | Map(print))
```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="162pt" height="442pt"
 viewBox="0.00 0.00 162.00 442.09" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 438.093)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-438.093 158,-438.093 158,4 -4,4"/>
<!-- Cell 72: Squares -->
<g id="node1" class="node"><title>Cell 72: Squares</title>
<polygon fill="none" stroke="blue" points="130.5,-290.093 23.5,-290.093 23.5,-254.093 130.5,-254.093 130.5,-290.093"/>
<text text-anchor="middle" x="77" y="-268.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 72: Squares</text>
</g>
<!-- pcoll4896 -->
<g id="node3" class="node"><title>pcoll4896</title>
<ellipse fill="none" stroke="blue" cx="77" cy="-200.093" rx="18" ry="18"/>
</g>
<!-- Cell 72: Squares&#45;&gt;pcoll4896 -->
<g id="edge1" class="edge"><title>Cell 72: Squares&#45;&gt;pcoll4896</title>
<path fill="none" stroke="black" d="M77,-253.79C77,-246.076 77,-236.806 77,-228.206"/>
<polygon fill="black" stroke="black" points="80.5001,-228.198 77,-218.198 73.5001,-228.198 80.5001,-228.198"/>
</g>
<!-- Cell 72: Create Elements -->
<g id="node2" class="node"><title>Cell 72: Create Elements</title>
<polygon fill="none" stroke="blue" points="154,-434.093 0,-434.093 0,-398.093 154,-398.093 154,-434.093"/>
<text text-anchor="middle" x="77" y="-412.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 72: Create Elements</text>
</g>
<!-- pcoll400 -->
<g id="node5" class="node"><title>pcoll400</title>
<ellipse fill="none" stroke="blue" cx="77" cy="-344.093" rx="18" ry="18"/>
</g>
<!-- Cell 72: Create Elements&#45;&gt;pcoll400 -->
<g id="edge4" class="edge"><title>Cell 72: Create Elements&#45;&gt;pcoll400</title>
<path fill="none" stroke="black" d="M77,-397.79C77,-390.076 77,-380.806 77,-372.206"/>
<polygon fill="black" stroke="black" points="80.5001,-372.198 77,-362.198 73.5001,-372.198 80.5001,-372.198"/>
</g>
<!-- Cell 72: Map(print) -->
<g id="node6" class="node"><title>Cell 72: Map(print)</title>
<polygon fill="none" stroke="blue" points="139,-146.093 15,-146.093 15,-110.093 139,-110.093 139,-146.093"/>
<text text-anchor="middle" x="77" y="-124.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 72: Map(print)</text>
</g>
<!-- pcoll4896&#45;&gt;Cell 72: Map(print) -->
<g id="edge5" class="edge"><title>pcoll4896&#45;&gt;Cell 72: Map(print)</title>
<path fill="none" stroke="black" d="M77,-181.79C77,-174.076 77,-164.806 77,-156.206"/>
<polygon fill="black" stroke="black" points="80.5001,-156.198 77,-146.198 73.5001,-156.198 80.5001,-156.198"/>
</g>
<!-- squares -->
<g id="node4" class="node"><title>squares</title>
<ellipse fill="none" stroke="blue" cx="77" cy="-37.0467" rx="37.0935" ry="37.0935"/>
<text text-anchor="middle" x="77" y="-33.3467" font-family="Times,serif" font-size="14.00" fill="blue">squares</text>
</g>
<!-- pcoll400&#45;&gt;Cell 72: Squares -->
<g id="edge3" class="edge"><title>pcoll400&#45;&gt;Cell 72: Squares</title>
<path fill="none" stroke="black" d="M77,-325.79C77,-318.076 77,-308.806 77,-300.206"/>
<polygon fill="black" stroke="black" points="80.5001,-300.198 77,-290.198 73.5001,-300.198 80.5001,-300.198"/>
</g>
<!-- Cell 72: Map(print)&#45;&gt;squares -->
<g id="edge2" class="edge"><title>Cell 72: Map(print)&#45;&gt;squares</title>
<path fill="none" stroke="black" d="M77,-109.924C77,-102.58 77,-93.6153 77,-84.5409"/>
<polygon fill="black" stroke="black" points="80.5001,-84.3296 77,-74.3296 73.5001,-84.3297 80.5001,-84.3296"/>
</g>
</g>
</svg>



    64
    16
    4
    1
    25
    36
    9
    121
    100
    144
    81
    0
    49


**ParDo** is a more general and the lowest level element-wise operation. It applies a given function to an element and outputs none, one or more elements. It's a 1 to (0,1,M) operation.


```python
import sympy

with beam.Pipeline(InteractiveRunner()) as p:
    N=8
    
    def divisors(element):
        divisor_list = sympy.divisors(element)
        return [(element, x) for x in divisor_list]  # has to be an iterable

    (p | "Create" >> Create(range(N))
       | "ParDo Divisors" >> ParDo(divisors)
       | "Print" >> ParDo(print))
```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="156pt" height="404pt"
 viewBox="0.00 0.00 156.00 404.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 400)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-400 152,-400 152,4 -4,4"/>
<!-- Cell 73: Print -->
<g id="node1" class="node"><title>Cell 73: Print</title>
<polygon fill="none" stroke="blue" points="119,-108 29,-108 29,-72 119,-72 119,-108"/>
<text text-anchor="middle" x="74" y="-86.3" font-family="Times,serif" font-size="14.00" fill="blue">Cell 73: Print</text>
</g>
<!-- pcoll4192 -->
<g id="node2" class="node"><title>pcoll4192</title>
<ellipse fill="none" stroke="blue" cx="74" cy="-18" rx="18" ry="18"/>
</g>
<!-- Cell 73: Print&#45;&gt;pcoll4192 -->
<g id="edge1" class="edge"><title>Cell 73: Print&#45;&gt;pcoll4192</title>
<path fill="none" stroke="black" d="M74,-71.6966C74,-63.9827 74,-54.7125 74,-46.1124"/>
<polygon fill="black" stroke="black" points="77.5001,-46.1043 74,-36.1043 70.5001,-46.1044 77.5001,-46.1043"/>
</g>
<!-- pcoll4896 -->
<g id="node3" class="node"><title>pcoll4896</title>
<ellipse fill="none" stroke="blue" cx="74" cy="-162" rx="18" ry="18"/>
</g>
<!-- pcoll4896&#45;&gt;Cell 73: Print -->
<g id="edge3" class="edge"><title>pcoll4896&#45;&gt;Cell 73: Print</title>
<path fill="none" stroke="black" d="M74,-143.697C74,-135.983 74,-126.712 74,-118.112"/>
<polygon fill="black" stroke="black" points="77.5001,-118.104 74,-108.104 70.5001,-118.104 77.5001,-118.104"/>
</g>
<!-- pcoll400 -->
<g id="node4" class="node"><title>pcoll400</title>
<ellipse fill="none" stroke="blue" cx="74" cy="-306" rx="18" ry="18"/>
</g>
<!-- Cell 73: ParDo Divisors -->
<g id="node5" class="node"><title>Cell 73: ParDo Divisors</title>
<polygon fill="none" stroke="blue" points="148,-252 0,-252 0,-216 148,-216 148,-252"/>
<text text-anchor="middle" x="74" y="-230.3" font-family="Times,serif" font-size="14.00" fill="blue">Cell 73: ParDo Divisors</text>
</g>
<!-- pcoll400&#45;&gt;Cell 73: ParDo Divisors -->
<g id="edge4" class="edge"><title>pcoll400&#45;&gt;Cell 73: ParDo Divisors</title>
<path fill="none" stroke="black" d="M74,-287.697C74,-279.983 74,-270.712 74,-262.112"/>
<polygon fill="black" stroke="black" points="77.5001,-262.104 74,-252.104 70.5001,-262.104 77.5001,-262.104"/>
</g>
<!-- Cell 73: ParDo Divisors&#45;&gt;pcoll4896 -->
<g id="edge5" class="edge"><title>Cell 73: ParDo Divisors&#45;&gt;pcoll4896</title>
<path fill="none" stroke="black" d="M74,-215.697C74,-207.983 74,-198.712 74,-190.112"/>
<polygon fill="black" stroke="black" points="77.5001,-190.104 74,-180.104 70.5001,-190.104 77.5001,-190.104"/>
</g>
<!-- Cell 73: Create -->
<g id="node6" class="node"><title>Cell 73: Create</title>
<polygon fill="none" stroke="blue" points="123.5,-396 24.5,-396 24.5,-360 123.5,-360 123.5,-396"/>
<text text-anchor="middle" x="74" y="-374.3" font-family="Times,serif" font-size="14.00" fill="blue">Cell 73: Create</text>
</g>
<!-- Cell 73: Create&#45;&gt;pcoll400 -->
<g id="edge2" class="edge"><title>Cell 73: Create&#45;&gt;pcoll400</title>
<path fill="none" stroke="black" d="M74,-359.697C74,-351.983 74,-342.712 74,-334.112"/>
<polygon fill="black" stroke="black" points="77.5001,-334.104 74,-324.104 70.5001,-334.104 77.5001,-334.104"/>
</g>
</g>
</svg>



    (1, 1)
    (2, 1)
    (2, 2)
    (7, 1)
    (7, 7)
    (5, 1)
    (5, 5)
    (3, 1)
    (3, 3)
    (6, 1)
    (6, 2)
    (6, 3)
    (6, 6)
    (4, 1)
    (4, 2)
    (4, 4)


Note that from N elements, the output is more than N elements (1 to M). This operation could not be done with Map, since it's 1 to 1.

### Branching Operations

**Flatten** combines two or more PCollections in one. It takes elements for all input PCollections and output them as one PCollections. It's the equivalen of UNION in SQL


```python
with beam.Pipeline(InteractiveRunner()) as p:
    elements_1 = [
        {"country": "China", "population": 1389},
        {"country": "India", "population": 1311},
        {"country": "USA", "population": 331},
        {"country": "Ireland", "population": 5}
    ]

    elements_2 = [
        {"country": "Indonesia", "population": 273},
        {"country": "Brazil", "population": 212},
        {"country": "Egypt", "population": 102},
        {"country": "Spain", "population": 47},
        {"country": "Ghana", "population": 31},
        {"country": "Australia", "population": 25},
    ]

    create_1 = p | "Create 1" >> Create(elements_1)
    create_2 = p | "Create 2" >> Create(elements_2)

    # Left side of | has to be a tuple
    ((create_1, create_2) | Flatten()
                          | ParDo(print))

```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="246pt" height="449pt"
 viewBox="0.00 0.00 246.00 448.59" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 444.593)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-444.593 242,-444.593 242,4 -4,4"/>
<!-- pcoll532 -->
<g id="node1" class="node"><title>pcoll532</title>
<ellipse fill="none" stroke="blue" cx="118" cy="-162" rx="18" ry="18"/>
</g>
<!-- Cell 53: ParDo(CallableWrapperDoFn) -->
<g id="node6" class="node"><title>Cell 53: ParDo(CallableWrapperDoFn)</title>
<polygon fill="none" stroke="blue" points="233.5,-108 2.5,-108 2.5,-72 233.5,-72 233.5,-108"/>
<text text-anchor="middle" x="118" y="-86.3" font-family="Times,serif" font-size="14.00" fill="blue">Cell 53: ParDo(CallableWrapperDoFn)</text>
</g>
<!-- pcoll532&#45;&gt;Cell 53: ParDo(CallableWrapperDoFn) -->
<g id="edge2" class="edge"><title>pcoll532&#45;&gt;Cell 53: ParDo(CallableWrapperDoFn)</title>
<path fill="none" stroke="black" d="M118,-143.697C118,-135.983 118,-126.712 118,-118.112"/>
<polygon fill="black" stroke="black" points="121.5,-118.104 118,-108.104 114.5,-118.104 121.5,-118.104"/>
</g>
<!-- pcoll1198 -->
<g id="node2" class="node"><title>pcoll1198</title>
<ellipse fill="none" stroke="blue" cx="118" cy="-18" rx="18" ry="18"/>
</g>
<!-- create_2 -->
<g id="node3" class="node"><title>create_2</title>
<ellipse fill="none" stroke="blue" cx="62" cy="-328.296" rx="40.0939" ry="40.0939"/>
<text text-anchor="middle" x="62" y="-324.596" font-family="Times,serif" font-size="14.00" fill="blue">create_2</text>
</g>
<!-- Cell 53: Flatten -->
<g id="node5" class="node"><title>Cell 53: Flatten</title>
<polygon fill="none" stroke="blue" points="168.5,-252 67.5,-252 67.5,-216 168.5,-216 168.5,-252"/>
<text text-anchor="middle" x="118" y="-230.3" font-family="Times,serif" font-size="14.00" fill="blue">Cell 53: Flatten</text>
</g>
<!-- create_2&#45;&gt;Cell 53: Flatten -->
<g id="edge4" class="edge"><title>create_2&#45;&gt;Cell 53: Flatten</title>
<path fill="none" stroke="black" d="M82.5343,-293.453C89.0828,-282.66 96.219,-270.898 102.362,-260.774"/>
<polygon fill="black" stroke="black" points="105.484,-262.376 107.679,-252.011 99.4992,-258.745 105.484,-262.376"/>
</g>
<!-- Cell 53: Create 1 -->
<g id="node4" class="node"><title>Cell 53: Create 1</title>
<polygon fill="none" stroke="blue" points="238,-440.593 128,-440.593 128,-404.593 238,-404.593 238,-440.593"/>
<text text-anchor="middle" x="183" y="-418.893" font-family="Times,serif" font-size="14.00" fill="blue">Cell 53: Create 1</text>
</g>
<!-- create_1 -->
<g id="node7" class="node"><title>create_1</title>
<ellipse fill="none" stroke="blue" cx="175" cy="-328.296" rx="40.0939" ry="40.0939"/>
<text text-anchor="middle" x="175" y="-324.596" font-family="Times,serif" font-size="14.00" fill="blue">create_1</text>
</g>
<!-- Cell 53: Create 1&#45;&gt;create_1 -->
<g id="edge6" class="edge"><title>Cell 53: Create 1&#45;&gt;create_1</title>
<path fill="none" stroke="black" d="M181.495,-404.233C180.864,-396.948 180.094,-388.07 179.309,-379.008"/>
<polygon fill="black" stroke="black" points="182.772,-378.433 178.422,-368.773 175.798,-379.038 182.772,-378.433"/>
</g>
<!-- Cell 53: Flatten&#45;&gt;pcoll532 -->
<g id="edge3" class="edge"><title>Cell 53: Flatten&#45;&gt;pcoll532</title>
<path fill="none" stroke="black" d="M118,-215.697C118,-207.983 118,-198.712 118,-190.112"/>
<polygon fill="black" stroke="black" points="121.5,-190.104 118,-180.104 114.5,-190.104 121.5,-190.104"/>
</g>
<!-- Cell 53: ParDo(CallableWrapperDoFn)&#45;&gt;pcoll1198 -->
<g id="edge1" class="edge"><title>Cell 53: ParDo(CallableWrapperDoFn)&#45;&gt;pcoll1198</title>
<path fill="none" stroke="black" d="M118,-71.6966C118,-63.9827 118,-54.7125 118,-46.1124"/>
<polygon fill="black" stroke="black" points="121.5,-46.1043 118,-36.1043 114.5,-46.1044 121.5,-46.1043"/>
</g>
<!-- create_1&#45;&gt;Cell 53: Flatten -->
<g id="edge7" class="edge"><title>create_1&#45;&gt;Cell 53: Flatten</title>
<path fill="none" stroke="black" d="M154.26,-293.714C147.583,-282.902 140.29,-271.093 134.007,-260.919"/>
<polygon fill="black" stroke="black" points="136.8,-258.78 128.567,-252.111 130.844,-262.458 136.8,-258.78"/>
</g>
<!-- Cell 53: Create 2 -->
<g id="node8" class="node"><title>Cell 53: Create 2</title>
<polygon fill="none" stroke="blue" points="110,-440.593 0,-440.593 0,-404.593 110,-404.593 110,-440.593"/>
<text text-anchor="middle" x="55" y="-418.893" font-family="Times,serif" font-size="14.00" fill="blue">Cell 53: Create 2</text>
</g>
<!-- Cell 53: Create 2&#45;&gt;create_2 -->
<g id="edge5" class="edge"><title>Cell 53: Create 2&#45;&gt;create_2</title>
<path fill="none" stroke="black" d="M56.3166,-404.233C56.8691,-396.948 57.5424,-388.07 58.2298,-379.008"/>
<polygon fill="black" stroke="black" points="61.7396,-379.009 59.006,-368.773 54.7597,-378.48 61.7396,-379.009"/>
</g>
</g>
</svg>



    {'population': 102, 'country': 'Egypt'}
    {'population': 47, 'country': 'Spain'}
    {'population': 273, 'country': 'Indonesia'}
    {'population': 31, 'country': 'Ghana'}
    {'population': 212, 'country': 'Brazil'}
    {'population': 25, 'country': 'Australia'}
    {'population': 331, 'country': 'USA'}
    {'population': 1311, 'country': 'India'}
    {'population': 1389, 'country': 'China'}
    {'population': 5, 'country': 'Ireland'}


 

**Branching** The same way we can join two or more PCollections into one, we can use the same PCollections as input for one or more PTransforms/Sinks. It is as simple as referencing a previous section of a pipeline.


```python
with beam.Pipeline(InteractiveRunner()) as p:

    elements = [
        {"country": "China", "population": 1389},
        {"country": "India", "population": 1311},
        {"country": "USA", "population": 331},
        {"country": "Ireland", "population": 5}
    ]

    create = p | "Create" >> Create(elements)

    country = create | "country" >> ParDo(lambda x: print("Country: {}".format(x["country"])))
    population = create | "population" >> ParDo(lambda x: print("Population: {}".format(x["population"])))
```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="254pt" height="348pt"
 viewBox="0.00 0.00 253.50 347.89" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 343.886)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-343.886 249.5,-343.886 249.5,4 -4,4"/>
<!-- Cell 54: Create -->
<g id="node1" class="node"><title>Cell 54: Create</title>
<polygon fill="none" stroke="blue" points="176.5,-339.886 77.5,-339.886 77.5,-303.886 176.5,-303.886 176.5,-339.886"/>
<text text-anchor="middle" x="127" y="-318.186" font-family="Times,serif" font-size="14.00" fill="blue">Cell 54: Create</text>
</g>
<!-- create -->
<g id="node6" class="node"><title>create</title>
<ellipse fill="none" stroke="blue" cx="127" cy="-236.039" rx="31.6951" ry="31.6951"/>
<text text-anchor="middle" x="127" y="-232.339" font-family="Times,serif" font-size="14.00" fill="blue">create</text>
</g>
<!-- Cell 54: Create&#45;&gt;create -->
<g id="edge4" class="edge"><title>Cell 54: Create&#45;&gt;create</title>
<path fill="none" stroke="black" d="M127,-303.513C127,-296.054 127,-286.996 127,-277.996"/>
<polygon fill="black" stroke="black" points="130.5,-277.949 127,-267.949 123.5,-277.95 130.5,-277.949"/>
</g>
<!-- population -->
<g id="node2" class="node"><title>population</title>
<ellipse fill="none" stroke="blue" cx="61" cy="-48.0957" rx="48.1917" ry="48.1917"/>
<text text-anchor="middle" x="61" y="-44.3957" font-family="Times,serif" font-size="14.00" fill="blue">population</text>
</g>
<!-- country -->
<g id="node3" class="node"><title>country</title>
<ellipse fill="none" stroke="blue" cx="193" cy="-48.0957" rx="37.8943" ry="37.8943"/>
<text text-anchor="middle" x="193" y="-44.3957" font-family="Times,serif" font-size="14.00" fill="blue">country</text>
</g>
<!-- Cell 54: population -->
<g id="node4" class="node"><title>Cell 54: population</title>
<polygon fill="none" stroke="blue" points="122,-168.191 -7.10543e-15,-168.191 -7.10543e-15,-132.191 122,-132.191 122,-168.191"/>
<text text-anchor="middle" x="61" y="-146.491" font-family="Times,serif" font-size="14.00" fill="blue">Cell 54: population</text>
</g>
<!-- Cell 54: population&#45;&gt;population -->
<g id="edge3" class="edge"><title>Cell 54: population&#45;&gt;population</title>
<path fill="none" stroke="black" d="M61,-131.756C61,-124.517 61,-115.664 61,-106.475"/>
<polygon fill="black" stroke="black" points="64.5001,-106.432 61,-96.4322 57.5001,-106.432 64.5001,-106.432"/>
</g>
<!-- Cell 54: country -->
<g id="node5" class="node"><title>Cell 54: country</title>
<polygon fill="none" stroke="blue" points="245.5,-168.191 140.5,-168.191 140.5,-132.191 245.5,-132.191 245.5,-168.191"/>
<text text-anchor="middle" x="193" y="-146.491" font-family="Times,serif" font-size="14.00" fill="blue">Cell 54: country</text>
</g>
<!-- Cell 54: country&#45;&gt;country -->
<g id="edge1" class="edge"><title>Cell 54: country&#45;&gt;country</title>
<path fill="none" stroke="black" d="M193,-131.756C193,-121.768 193,-108.709 193,-95.9316"/>
<polygon fill="black" stroke="black" points="196.5,-95.8081 193,-85.8082 189.5,-95.8082 196.5,-95.8081"/>
</g>
<!-- create&#45;&gt;Cell 54: population -->
<g id="edge5" class="edge"><title>create&#45;&gt;Cell 54: population</title>
<path fill="none" stroke="black" d="M107.555,-210.335C99.1538,-199.663 89.3343,-187.188 80.8849,-176.453"/>
<polygon fill="black" stroke="black" points="83.391,-173.978 74.4556,-168.286 77.8906,-178.308 83.391,-173.978"/>
</g>
<!-- create&#45;&gt;Cell 54: country -->
<g id="edge2" class="edge"><title>create&#45;&gt;Cell 54: country</title>
<path fill="none" stroke="black" d="M146.445,-210.335C154.846,-199.663 164.666,-187.188 173.115,-176.453"/>
<polygon fill="black" stroke="black" points="176.109,-178.308 179.544,-168.286 170.609,-173.978 176.109,-178.308"/>
</g>
</g>
</svg>



    Country: USA
    Population: 331
    Country: China
    Population: 1389
    Country: India
    Population: 1311
    Country: Ireland
    Population: 5


There are other more clever ways to branch. Sometimes we would like to split the PCollection in two or more PCollections:

**Partition** sends elements to different PTransform following a given function. It applies a function element-wise which outputs the index of the pipeline which the element should go to


```python
with beam.Pipeline() as p:
    even, odd = (p | "Create Numbers" >> Create(range(10))
                 | "Odd or Even" >> Partition(lambda n, partitions: n % 2, 2))
    # lambda x,y: which partition fn, number partitions
    # even would be when the fn outputs 0, odd when it outputs 1

    even | Map(lambda x: print("Even: {}".format(x)))
    odd | Map(lambda x: print("Odd: {}".format(x)))
```

    Odd: 9
    Odd: 3
    Even: 0
    Even: 6
    Odd: 1
    Even: 2
    Even: 4
    Odd: 7
    Even: 8
    Odd: 5


_________________________________
This option still does not cover all posibilites. What if we wanted a particular element to fall into two or more different categories?

We can use **ParDo** and the **TaggedOutput** option to achieve this. This is the most flexible way to branch PCollections.


```python
with beam.Pipeline(InteractiveRunner()) as p:

    class DiffOutputsFn(beam.DoFn):

        def process(self, element, x, y):
            if element % x == 0:
                yield pvalue.TaggedOutput("x", element)

            if element % y == 0:
                yield pvalue.TaggedOutput("y", element)
                
            yield element


    diff_outputs = (p | "Create" >> Create(range(8))
                      | "Split Outputs" >> ParDo(DiffOutputsFn(), x=2, y=3).with_outputs("x", "y"))

    multiple_x = diff_outputs.x | "Multiples of X" >> Map(lambda e: print("Multiples of X: {}".format(e)))

    multiple_y = diff_outputs.y | "Multiples of Y" >> Map(lambda e: print("Multiples of Y: {}".format(e)))

    all_outputs = diff_outputs[None] | "All" >> Map(lambda e: print("All: {}".format(e)))
```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="425pt" height="468pt"
 viewBox="0.00 0.00 424.55 468.09" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 464.091)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-464.091 420.546,-464.091 420.546,4 -4,4"/>
<!-- all_outputs -->
<g id="node1" class="node"><title>all_outputs</title>
<ellipse fill="none" stroke="blue" cx="366.5" cy="-50.0456" rx="50.0912" ry="50.0912"/>
<text text-anchor="middle" x="366.5" y="-46.3456" font-family="Times,serif" font-size="14.00" fill="blue">all_outputs</text>
</g>
<!-- pcoll3160 -->
<g id="node2" class="node"><title>pcoll3160</title>
<ellipse fill="none" stroke="blue" cx="126.5" cy="-226.091" rx="18" ry="18"/>
</g>
<!-- Cell 75: Multiples of Y -->
<g id="node8" class="node"><title>Cell 75: Multiples of Y</title>
<polygon fill="none" stroke="blue" points="145,-172.091 0,-172.091 0,-136.091 145,-136.091 145,-172.091"/>
<text text-anchor="middle" x="72.5" y="-150.391" font-family="Times,serif" font-size="14.00" fill="blue">Cell 75: Multiples of Y</text>
</g>
<!-- pcoll3160&#45;&gt;Cell 75: Multiples of Y -->
<g id="edge2" class="edge"><title>pcoll3160&#45;&gt;Cell 75: Multiples of Y</title>
<path fill="none" stroke="black" d="M115.831,-211.261C108.992,-202.395 99.913,-190.626 91.833,-180.152"/>
<polygon fill="black" stroke="black" points="94.5083,-177.89 85.629,-172.11 88.9658,-182.166 94.5083,-177.89"/>
</g>
<!-- multiple_x -->
<g id="node3" class="node"><title>multiple_x</title>
<ellipse fill="none" stroke="blue" cx="235.5" cy="-50.0456" rx="49.2915" ry="49.2915"/>
<text text-anchor="middle" x="235.5" y="-46.3456" font-family="Times,serif" font-size="14.00" fill="blue">multiple_x</text>
</g>
<!-- pcoll4192 -->
<g id="node4" class="node"><title>pcoll4192</title>
<ellipse fill="none" stroke="blue" cx="235.5" cy="-226.091" rx="18" ry="18"/>
</g>
<!-- Cell 75: Multiples of X -->
<g id="node5" class="node"><title>Cell 75: Multiples of X</title>
<polygon fill="none" stroke="blue" points="308,-172.091 163,-172.091 163,-136.091 308,-136.091 308,-172.091"/>
<text text-anchor="middle" x="235.5" y="-150.391" font-family="Times,serif" font-size="14.00" fill="blue">Cell 75: Multiples of X</text>
</g>
<!-- pcoll4192&#45;&gt;Cell 75: Multiples of X -->
<g id="edge1" class="edge"><title>pcoll4192&#45;&gt;Cell 75: Multiples of X</title>
<path fill="none" stroke="black" d="M235.5,-207.788C235.5,-200.074 235.5,-190.804 235.5,-182.204"/>
<polygon fill="black" stroke="black" points="239,-182.195 235.5,-172.195 232,-182.195 239,-182.195"/>
</g>
<!-- Cell 75: Multiples of X&#45;&gt;multiple_x -->
<g id="edge9" class="edge"><title>Cell 75: Multiples of X&#45;&gt;multiple_x</title>
<path fill="none" stroke="black" d="M235.5,-135.78C235.5,-128.431 235.5,-119.392 235.5,-109.985"/>
<polygon fill="black" stroke="black" points="239,-109.696 235.5,-99.6961 232,-109.696 239,-109.696"/>
</g>
<!-- Cell 75: Create -->
<g id="node6" class="node"><title>Cell 75: Create</title>
<polygon fill="none" stroke="blue" points="285,-460.091 186,-460.091 186,-424.091 285,-424.091 285,-460.091"/>
<text text-anchor="middle" x="235.5" y="-438.391" font-family="Times,serif" font-size="14.00" fill="blue">Cell 75: Create</text>
</g>
<!-- pcoll400 -->
<g id="node11" class="node"><title>pcoll400</title>
<ellipse fill="none" stroke="blue" cx="235.5" cy="-370.091" rx="18" ry="18"/>
</g>
<!-- Cell 75: Create&#45;&gt;pcoll400 -->
<g id="edge5" class="edge"><title>Cell 75: Create&#45;&gt;pcoll400</title>
<path fill="none" stroke="black" d="M235.5,-423.788C235.5,-416.074 235.5,-406.804 235.5,-398.204"/>
<polygon fill="black" stroke="black" points="239,-398.195 235.5,-388.195 232,-398.195 239,-398.195"/>
</g>
<!-- Cell 75: All -->
<g id="node7" class="node"><title>Cell 75: All</title>
<polygon fill="none" stroke="blue" points="407,-172.091 326,-172.091 326,-136.091 407,-136.091 407,-172.091"/>
<text text-anchor="middle" x="366.5" y="-150.391" font-family="Times,serif" font-size="14.00" fill="blue">Cell 75: All</text>
</g>
<!-- Cell 75: All&#45;&gt;all_outputs -->
<g id="edge4" class="edge"><title>Cell 75: All&#45;&gt;all_outputs</title>
<path fill="none" stroke="black" d="M366.5,-135.78C366.5,-128.514 366.5,-119.597 366.5,-110.306"/>
<polygon fill="black" stroke="black" points="370,-110.137 366.5,-100.137 363,-110.137 370,-110.137"/>
</g>
<!-- multiple_y -->
<g id="node9" class="node"><title>multiple_y</title>
<ellipse fill="none" stroke="blue" cx="72.5" cy="-50.0456" rx="49.2915" ry="49.2915"/>
<text text-anchor="middle" x="72.5" y="-46.3456" font-family="Times,serif" font-size="14.00" fill="blue">multiple_y</text>
</g>
<!-- Cell 75: Multiples of Y&#45;&gt;multiple_y -->
<g id="edge7" class="edge"><title>Cell 75: Multiples of Y&#45;&gt;multiple_y</title>
<path fill="none" stroke="black" d="M72.5,-135.78C72.5,-128.431 72.5,-119.392 72.5,-109.985"/>
<polygon fill="black" stroke="black" points="76.0001,-109.696 72.5,-99.6961 69.0001,-109.696 76.0001,-109.696"/>
</g>
<!-- pcoll4896 -->
<g id="node10" class="node"><title>pcoll4896</title>
<ellipse fill="none" stroke="blue" cx="327.5" cy="-226.091" rx="18" ry="18"/>
</g>
<!-- pcoll4896&#45;&gt;Cell 75: All -->
<g id="edge3" class="edge"><title>pcoll4896&#45;&gt;Cell 75: All</title>
<path fill="none" stroke="black" d="M335.962,-209.902C340.648,-201.492 346.602,-190.806 352.005,-181.108"/>
<polygon fill="black" stroke="black" points="355.148,-182.657 356.958,-172.218 349.033,-179.25 355.148,-182.657"/>
</g>
<!-- Cell 75: Split Outputs -->
<g id="node12" class="node"><title>Cell 75: Split Outputs</title>
<polygon fill="none" stroke="blue" points="303.5,-316.091 167.5,-316.091 167.5,-280.091 303.5,-280.091 303.5,-316.091"/>
<text text-anchor="middle" x="235.5" y="-294.391" font-family="Times,serif" font-size="14.00" fill="blue">Cell 75: Split Outputs</text>
</g>
<!-- pcoll400&#45;&gt;Cell 75: Split Outputs -->
<g id="edge6" class="edge"><title>pcoll400&#45;&gt;Cell 75: Split Outputs</title>
<path fill="none" stroke="black" d="M235.5,-351.788C235.5,-344.074 235.5,-334.804 235.5,-326.204"/>
<polygon fill="black" stroke="black" points="239,-326.195 235.5,-316.195 232,-326.195 239,-326.195"/>
</g>
<!-- Cell 75: Split Outputs&#45;&gt;pcoll3160 -->
<g id="edge10" class="edge"><title>Cell 75: Split Outputs&#45;&gt;pcoll3160</title>
<path fill="none" stroke="black" d="M208.836,-279.967C190.861,-268.424 167.366,-253.335 150.076,-242.232"/>
<polygon fill="black" stroke="black" points="151.489,-238.98 141.183,-236.521 147.706,-244.87 151.489,-238.98"/>
</g>
<!-- Cell 75: Split Outputs&#45;&gt;pcoll4192 -->
<g id="edge11" class="edge"><title>Cell 75: Split Outputs&#45;&gt;pcoll4192</title>
<path fill="none" stroke="black" d="M235.5,-279.788C235.5,-272.074 235.5,-262.804 235.5,-254.204"/>
<polygon fill="black" stroke="black" points="239,-254.195 235.5,-244.195 232,-254.195 239,-254.195"/>
</g>
<!-- Cell 75: Split Outputs&#45;&gt;pcoll4896 -->
<g id="edge8" class="edge"><title>Cell 75: Split Outputs&#45;&gt;pcoll4896</title>
<path fill="none" stroke="black" d="M258.242,-279.788C272.607,-268.858 291.079,-254.803 305.333,-243.958"/>
<polygon fill="black" stroke="black" points="307.749,-246.517 313.588,-237.676 303.51,-240.946 307.749,-246.517"/>
</g>
</g>
</svg>



    Multiples of X: 4
    All: 4
    Multiples of X: 2
    All: 2
    All: 5
    Multiples of X: 0
    Multiples of Y: 0
    All: 0
    All: 1
    All: 7
    Multiples of X: 6
    Multiples of Y: 6
    All: 6
    Multiples of Y: 3
    All: 3


Let's go a bit through the code. 

We are sending the elements to 3 subsections:

- Containing the multiples of X or Y: 
    * To send elements there, we use `yield` to that tagged output `yield pvalue.TaggedOutput("x", element)`
    * To retrieve elements from that pipeline, we simply refer to the original subpipeline `diff_outputs` with the tagged key *x* or *y*: `diff_outputs.x`


- All elements: 
    * In this case, we don't need to specify the tagged output, so we simply use `yield`
    * To reference this outputs, we need to reference the elements without a tag, so we do it using `diff_outputs[None]`
    
Also, let's check how the `ParDo` is being used:

- `ParDo(DiffOutputsFn(), x=2, y=3).with_outputs("x", "y"))`
    * We use `with_outputs` to reference the name of the tagged outputs
    * Note how we are passing the parameters `x` and `y` to the `DiffOutputsFn` Class



Let's see another example just to be sure we got it. In this case we only want to process words with more than 5 letters, the smaller ones are discarded.


```python
with beam.Pipeline(InteractiveRunner()) as p:

    class LengthStringFn(beam.DoFn):

        def process(self, element, max_len):
            if len(element) <= max_len:
                yield pvalue.TaggedOutput("smaller", element)
            else:
                yield element
    
    elements = ["Beam", "Pipeline", "Step", "Map", "Notebook"]

    string_length = (p | "Create" >> Create(elements)
                      | "Split Outputs" >> ParDo(LengthStringFn(), max_len=5).with_outputs("smaller"))

    smaller = string_length.smaller | "Discarded" >> Map(lambda e: print("Discarded: {}".format(e)))

    bigger = string_length[None] | "Filtered" >> Map(lambda e: print("Bigger: {}".format(e)))
```


<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="252pt" height="442pt"
 viewBox="0.00 0.00 251.50 442.09" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 438.093)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-438.093 247.5,-438.093 247.5,4 -4,4"/>
<!-- Cell 79: Split Outputs -->
<g id="node1" class="node"><title>Cell 79: Split Outputs</title>
<polygon fill="none" stroke="blue" points="167,-290.093 31,-290.093 31,-254.093 167,-254.093 167,-290.093"/>
<text text-anchor="middle" x="99" y="-268.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 79: Split Outputs</text>
</g>
<!-- pcoll4896 -->
<g id="node4" class="node"><title>pcoll4896</title>
<ellipse fill="none" stroke="blue" cx="72" cy="-200.093" rx="18" ry="18"/>
</g>
<!-- Cell 79: Split Outputs&#45;&gt;pcoll4896 -->
<g id="edge1" class="edge"><title>Cell 79: Split Outputs&#45;&gt;pcoll4896</title>
<path fill="none" stroke="black" d="M92.3258,-253.79C89.1606,-245.584 85.3161,-235.617 81.8261,-226.569"/>
<polygon fill="black" stroke="black" points="85.0915,-225.308 78.2272,-217.238 78.5605,-227.828 85.0915,-225.308"/>
</g>
<!-- pcoll4192 -->
<g id="node5" class="node"><title>pcoll4192</title>
<ellipse fill="none" stroke="blue" cx="164" cy="-200.093" rx="18" ry="18"/>
</g>
<!-- Cell 79: Split Outputs&#45;&gt;pcoll4192 -->
<g id="edge3" class="edge"><title>Cell 79: Split Outputs&#45;&gt;pcoll4192</title>
<path fill="none" stroke="black" d="M115.067,-253.79C124.175,-243.982 135.618,-231.658 145.148,-221.395"/>
<polygon fill="black" stroke="black" points="147.753,-223.734 151.993,-214.024 142.623,-218.971 147.753,-223.734"/>
</g>
<!-- pcoll400 -->
<g id="node2" class="node"><title>pcoll400</title>
<ellipse fill="none" stroke="blue" cx="99" cy="-344.093" rx="18" ry="18"/>
</g>
<!-- pcoll400&#45;&gt;Cell 79: Split Outputs -->
<g id="edge6" class="edge"><title>pcoll400&#45;&gt;Cell 79: Split Outputs</title>
<path fill="none" stroke="black" d="M99,-325.79C99,-318.076 99,-308.806 99,-300.206"/>
<polygon fill="black" stroke="black" points="102.5,-300.198 99,-290.198 95.5001,-300.198 102.5,-300.198"/>
</g>
<!-- smaller -->
<g id="node3" class="node"><title>smaller</title>
<ellipse fill="none" stroke="blue" cx="184" cy="-37.0467" rx="37.0935" ry="37.0935"/>
<text text-anchor="middle" x="184" y="-33.3467" font-family="Times,serif" font-size="14.00" fill="blue">smaller</text>
</g>
<!-- Cell 79: Filtered -->
<g id="node9" class="node"><title>Cell 79: Filtered</title>
<polygon fill="none" stroke="blue" points="106,-146.093 7.10543e-15,-146.093 7.10543e-15,-110.093 106,-110.093 106,-146.093"/>
<text text-anchor="middle" x="53" y="-124.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 79: Filtered</text>
</g>
<!-- pcoll4896&#45;&gt;Cell 79: Filtered -->
<g id="edge8" class="edge"><title>pcoll4896&#45;&gt;Cell 79: Filtered</title>
<path fill="none" stroke="black" d="M67.4973,-182.504C65.3834,-174.717 62.8082,-165.229 60.4179,-156.422"/>
<polygon fill="black" stroke="black" points="63.7329,-155.274 57.7356,-146.54 56.9773,-157.108 63.7329,-155.274"/>
</g>
<!-- Cell 79: Discarded -->
<g id="node8" class="node"><title>Cell 79: Discarded</title>
<polygon fill="none" stroke="blue" points="243.5,-146.093 124.5,-146.093 124.5,-110.093 243.5,-110.093 243.5,-146.093"/>
<text text-anchor="middle" x="184" y="-124.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 79: Discarded</text>
</g>
<!-- pcoll4192&#45;&gt;Cell 79: Discarded -->
<g id="edge5" class="edge"><title>pcoll4192&#45;&gt;Cell 79: Discarded</title>
<path fill="none" stroke="black" d="M168.74,-182.504C170.965,-174.717 173.676,-165.229 176.192,-156.422"/>
<polygon fill="black" stroke="black" points="179.633,-157.117 179.015,-146.54 172.903,-155.194 179.633,-157.117"/>
</g>
<!-- bigger -->
<g id="node6" class="node"><title>bigger</title>
<ellipse fill="none" stroke="blue" cx="53" cy="-37.0467" rx="33.2948" ry="33.2948"/>
<text text-anchor="middle" x="53" y="-33.3467" font-family="Times,serif" font-size="14.00" fill="blue">bigger</text>
</g>
<!-- Cell 79: Create -->
<g id="node7" class="node"><title>Cell 79: Create</title>
<polygon fill="none" stroke="blue" points="148.5,-434.093 49.5,-434.093 49.5,-398.093 148.5,-398.093 148.5,-434.093"/>
<text text-anchor="middle" x="99" y="-412.393" font-family="Times,serif" font-size="14.00" fill="blue">Cell 79: Create</text>
</g>
<!-- Cell 79: Create&#45;&gt;pcoll400 -->
<g id="edge4" class="edge"><title>Cell 79: Create&#45;&gt;pcoll400</title>
<path fill="none" stroke="black" d="M99,-397.79C99,-390.076 99,-380.806 99,-372.206"/>
<polygon fill="black" stroke="black" points="102.5,-372.198 99,-362.198 95.5001,-372.198 102.5,-372.198"/>
</g>
<!-- Cell 79: Discarded&#45;&gt;smaller -->
<g id="edge7" class="edge"><title>Cell 79: Discarded&#45;&gt;smaller</title>
<path fill="none" stroke="black" d="M184,-109.924C184,-102.58 184,-93.6153 184,-84.5409"/>
<polygon fill="black" stroke="black" points="187.5,-84.3296 184,-74.3296 180.5,-84.3297 187.5,-84.3296"/>
</g>
<!-- Cell 79: Filtered&#45;&gt;bigger -->
<g id="edge2" class="edge"><title>Cell 79: Filtered&#45;&gt;bigger</title>
<path fill="none" stroke="black" d="M53,-109.924C53,-101.51 53,-90.9665 53,-80.5692"/>
<polygon fill="black" stroke="black" points="56.5001,-80.3047 53,-70.3048 49.5001,-80.3048 56.5001,-80.3047"/>
</g>
</g>
</svg>



    Bigger: Notebook
    Discarded: Beam
    Discarded: Step
    Bigger: Pipeline
    Discarded: Map


## Exercise

We are going to create elements (integers) coming from two sources, then we are going to add 1. We would split those in bigger or smaller than a given M.



```python

with beam.Pipeline() as p:
    
    M = 73

    elements_1 = random.sample(range(100), 5)
    elements_2 = [3, 5, 1729, 72]


    # TODO: Finish the pipeline 
    create_1 = p | "Create" >> Create(  ) 
              
    
```

### Hints

**Create elements**
<details><summary>Hint</summary>
<p>

    We need to use create twice, since we are using two sources. Don't forget the name of the steps has to be different

</p>
</details>


<details><summary>Code</summary>
<p>

```
   create_1 = p | "Create_1" >> Create(elements_1)
   create_2 = p | "Create_2" >> Create(elements_2) 
```

</p>
</details>

**Proccess created elements**
<details><summary>Hint</summary>
<p>

    Since we are reading from two sources and we are going to perform the same operations, we need to join them using a *Flatten*. Then, a Map would suffice to add 1 to them

</p>
</details>


<details><summary>Code</summary>
<p>

```

    flattened = ((create_1, create_2) | Flatten()
                                      | Map(lambda x: x+1))
```

</p>
</details>

**Split elements given according to a rule**
<details><summary>Hint</summary>
<p>

     We need to send elements to a different steps given a rule (comparing with M), we can do so using `Partition` or the general `ParDo withOutputTags`. Potentially, this could also be done with `Filter`, but we would need to process every element twice, so it's not recommended

</p>
</details>


<details><summary>Code</summary>
<p>


```
    def comparer(e, MAX):
        if e >= MAX:
            #return to index 1 (bigger)
            return 1
        else:
            #return to index 0 (smaller)
            return 0
    
    [...]
    
    smaller, bigger = flattened | "Partition" >> Partition(lambda x, partition: comparer(x, M), 2)
    
```

</p>
</details>

**Full code**
<details><summary>Code</summary>
<p>

```
with beam.Pipeline() as p:
    
    M = 73
    
    def comparer(e, MAX):
        if e >= MAX:
            #return to index 1 (bigger)
            return 1
        else:
            #return to index 0 (smaller)
            return 0

    elements_1 = random.sample(range(100), 5)
    elements_2 = [3, 5, 1729, 72]


    # TODO: Finish the pipeline 
    create_1 = p | "Create1" >> Create(elements_1)
    create_2 = p | "Create2" >> Create(elements_2) 
    
    flattened = ((create_1, create_2) | Flatten()
                                      | Map(lambda x: x+1))
    
    smaller, bigger = flattened | "Partition" >> Partition(lambda x, partition: comparer(x, M), 2)
    
    smaller | "Smaller" >> Map(lambda x: print("Smaller {}".format(x)))
    bigger | "Bigger" >> Map(lambda x: print("Bigger {}".format(x)))
```
    

</p>
</details>



```python

```


```python

```
